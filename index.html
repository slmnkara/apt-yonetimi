<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apartman Y√∂netim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .hidden-view {
            display: none !important;
        }

        .loading {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        @media print {
            body * {
                visibility: hidden;
                /* Her ≈üeyi gizle */
            }

            #printArea,
            #printArea * {
                visibility: visible;
                /* Sadece rapor alanƒ±nƒ± g√∂ster */
            }

            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
                font-family: 'Times New Roman', Times, serif;
                /* Yazƒ±cƒ± dostu font */
            }
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">

    <div id="loadingScreen" class="loading">
        <div class="text-2xl font-bold text-blue-600"><i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...</div>
    </div>

    <section id="loginView" class="hidden-view min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">Y√∂netici Giri≈üi</h2>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="email" placeholder="Email"
                    class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="password" id="password" placeholder="≈ûifre"
                    class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit"
                    class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition">Giri≈ü Yap</button>
            </form>
            <p class="mt-4 text-sm text-gray-500 text-center">Sakinler kendilerine √∂zel link ile giri≈ü yapabilirler.</p>
        </div>
    </section>

    <section id="adminView" class="hidden-view min-h-screen">
        <nav class="bg-blue-800 text-white p-4 flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold"><i class="fas fa-building"></i> Y√∂netim Paneli</h1>
            <button id="btnLogout" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 text-sm">√áƒ±kƒ±≈ü</button>
        </nav>

        <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">

            <div class="bg-white p-6 rounded-lg shadow lg:col-span-1">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">üí∞ Kasa Durumu</h3>
                <div class="text-3xl font-bold text-green-600 mb-2" id="kasaBakiye">0 ‚Ç∫</div>
                <div class="flex gap-2 mb-4">
                    <button onclick="openModal('modalIncome')"
                        class="flex-1 bg-green-100 text-green-700 py-2 rounded hover:bg-green-200">+ Gelir/Gider
                        Ekle</button>
                </div>
                <h4 class="font-semibold text-sm text-gray-500 mb-2">Son Hareketler</h4>
                <ul id="kasaList" class="text-sm space-y-2 max-h-48 overflow-y-auto">
                </ul>

                <div class="mt-4 mb-2 border-t pt-4">
                    <h4 class="font-semibold text-sm text-gray-500 mb-2">Rapor Al</h4>
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                            <input type="date" id="reportStartDate" class="border p-1 text-sm rounded w-full">
                            <input type="date" id="reportEndDate" class="border p-1 text-sm rounded w-full">
                        </div>
                        <button onclick="printKasaReport()"
                            class="bg-gray-700 text-white text-sm py-1 rounded hover:bg-gray-800">
                            <i class="fas fa-print"></i> Raporu Yazdƒ±r
                        </button>
                    </div>
                </div>

                <div id="printArea" class="hidden-view bg-white p-8">
                </div>
            </div>


            <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">‚ö° Hƒ±zlƒ± ƒ∞≈ülemler</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div class="border p-4 rounded bg-gray-50">
                        <h4 class="font-bold mb-2">Toplu / Se√ßili Bor√ßlandƒ±r</h4>
                        <input type="text" id="borcAciklama" placeholder="√ñrn: Kasƒ±m Aidatƒ±"
                            class="w-full mb-2 p-2 border rounded text-sm">
                        <input type="number" id="borcMiktar" placeholder="Tutar (‚Ç∫)"
                            class="w-full mb-2 p-2 border rounded text-sm">
                        <div class="flex gap-2">
                            <button id="btnTopluBorc"
                                class="bg-indigo-600 text-white px-3 py-2 rounded text-sm hover:bg-indigo-700 flex-1">T√ºm√ºne
                                Ekle</button>
                            <button id="btnSeciliBorc"
                                class="bg-orange-500 text-white px-3 py-2 rounded text-sm hover:bg-orange-600 flex-1">Se√ßililere
                                Ekle</button>
                        </div>
                    </div>
                    <div class="border p-4 rounded bg-gray-50">
                        <h4 class="font-bold mb-2">Yeni Mesken Ekle</h4>
                        <form id="addMeskenForm" class="flex flex-col gap-2">
                            <input type="text" id="yeniSakinAdi" placeholder="Sakin Adƒ± Soyadƒ±"
                                class="p-2 border rounded text-sm" required>
                            <input type="text" id="yeniDaireNo" placeholder="Daire No (√ñrn: 5)"
                                class="p-2 border rounded text-sm" required>
                            <button type="submit"
                                class="bg-gray-800 text-white py-2 rounded text-sm hover:bg-gray-900">Kaydet</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow lg:col-span-3">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">üè¢ Mesken Listesi</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-sm text-gray-600">
                                <th class="p-3"><input type="checkbox" id="selectAll"></th>
                                <th class="p-3">Daire</th>
                                <th class="p-3">Sakin</th>
                                <th class="p-3">Bakiye Durumu</th>
                                <th class="p-3">√ñzel Link</th>
                                <th class="p-3">ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="meskenTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="residentView" class="hidden-view min-h-screen bg-slate-50 p-4">
        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden mt-10">
            <div class="bg-blue-600 p-6 text-white">
                <h2 class="text-2xl font-bold" id="resSakinAdi">Sakin Adƒ±</h2>
                <p class="opacity-90" id="resDaireNo">Daire: --</p>
            </div>

            <div class="p-6">
                <h3 class="text-lg font-bold text-red-600 mb-3 border-b pb-1">√ñdenmemi≈ü Bor√ßlar</h3>
                <div id="resUnpaidList" class="space-y-3 mb-8">
                    <p class="text-gray-500 italic">√ñdenmemi≈ü borcunuz bulunmamaktadƒ±r.</p>
                </div>

                <h3 class="text-lg font-bold text-green-600 mb-3 border-b pb-1">√ñdeme Ge√ßmi≈üi</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Tarih</th>
                                <th class="p-2 text-left">A√ßƒ±klama</th>
                                <th class="p-2 text-right">Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="resHistoryBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <div id="modalIncome"
        class="hidden-view fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Kasa Hareketi Ekle</h3>
            <select id="kasaType" class="w-full p-2 border rounded mb-2">
                <option value="gelir">Para Giri≈üi (Gelir)</option>
                <option value="gider">Para √áƒ±kƒ±≈üƒ± (Gider)</option>
            </select>
            <input type="text" id="kasaDesc" placeholder="A√ßƒ±klama" class="w-full p-2 border rounded mb-2">
            <input type="number" id="kasaAmount" placeholder="Tutar" class="w-full p-2 border rounded mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modalIncome')" class="text-gray-500 px-3 py-1">ƒ∞ptal</button>
                <button onclick="saveKasaIslem()" class="bg-blue-600 text-white px-3 py-1 rounded">Kaydet</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. FIREBASE CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, getDocs, updateDoc, arrayUnion, arrayRemove, setDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // !!! BURAYI DOLDURUN !!!
        const firebaseConfig = {

            apiKey: "AIzaSyDQvOKkB3qifOq7TVUgoPwjIf9WmJBmLj0",

            authDomain: "apt-yonetimi-a6713.firebaseapp.com",

            projectId: "apt-yonetimi-a6713",

            storageBucket: "apt-yonetimi-a6713.firebasestorage.app",

            messagingSenderId: "93448629214",

            appId: "1:93448629214:web:e3de7671f3873cf40a0b4f"

        };


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. GLOBAL DEƒûƒ∞≈ûKENLER ---
        const views = {
            loading: document.getElementById('loadingScreen'),
            login: document.getElementById('loginView'),
            admin: document.getElementById('adminView'),
            resident: document.getElementById('residentView')
        };
        let currentAdminData = null;
        let meskenListesi = [];
        let globalKasaHareketler = []; // Yeni deƒüi≈üken

        // --- 3. BA≈ûLANGI√á MANTIƒûI (ROUTING) ---
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const residentId = params.get('id');

            if (residentId) {
                // URL Parametresi varsa -> SAKƒ∞N MODU
                await loadResidentData(residentId);
            } else {
                // Parametre yoksa -> ADMIN MODU (Auth kontrol√º)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        loadAdminDashboard();
                    } else {
                        showView('login');
                    }
                });
            }
        }

        function showView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden-view'));
            views[viewName].classList.remove('hidden-view');
        }

        // --- 4. ADMIN FONKSƒ∞YONLARI ---

        // Giri≈ü Yap
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                alert("Hata: " + err.message);
            }
        });

        // √áƒ±kƒ±≈ü Yap
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        // Admin Verilerini Y√ºkle
        function loadAdminDashboard() {
            showView('admin');

            // Kasa Dinle
            const kasaRef = doc(db, "kasa", "ana_kasa");
            // loadAdminDashboard i√ßindeki kasaRef onSnapshot kƒ±smƒ±nƒ± bununla deƒüi≈ütir:
            onSnapshot(kasaRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    globalKasaHareketler = data.hareketler || []; // Veriyi global deƒüi≈ükene atadƒ±k
                    document.getElementById('kasaBakiye').innerText = `${data.toplam_bakiye || 0} ‚Ç∫`;
                    renderKasaList(globalKasaHareketler);
                } else {
                    setDoc(kasaRef, { toplam_bakiye: 0, hareketler: [] });
                }
            });

            // Meskenleri Dinle
            const meskenRef = collection(db, "meskenler");
            onSnapshot(meskenRef, (snapshot) => {
                meskenListesi = [];
                snapshot.forEach(doc => {
                    meskenListesi.push({ dbId: doc.id, ...doc.data() });
                });
                renderMeskenTable();
            });
        }

        // Kasa Listesi Render
        function renderKasaList(hareketler) {
            const list = document.getElementById('kasaList');
            list.innerHTML = '';
            // Sondan ba≈üa (yeniler √ºstte)
            hareketler.slice().reverse().forEach(h => {
                const color = h.tur === 'gelir' ? 'text-green-600' : 'text-red-600';
                const icon = h.tur === 'gelir' ? '+' : '-';
                list.innerHTML += `
                    <li class="flex justify-between border-b pb-1 last:border-0">
                        <span>${h.aciklama}</span>
                        <span class="${color} font-bold">${icon}${h.tutar} ‚Ç∫</span>
                    </li>
                `;
            });
        }

        // Mesken Ekle
        document.getElementById('addMeskenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const adi = document.getElementById('yeniSakinAdi').value;
            const daire = document.getElementById('yeniDaireNo').value;

            // Random Unique ID olu≈ütur
            const uniqueUrlId = Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 6);

            await addDoc(collection(db, "meskenler"), {
                sakin_adi: adi,
                kod: daire,
                mesken_url: uniqueUrlId,
                borclar: [],
                odemeler: []
            });
            e.target.reset();
        });

        // Mesken Tablosu Render
        function renderMeskenTable() {
            const tbody = document.getElementById('meskenTableBody');
            tbody.innerHTML = '';
            meskenListesi.sort((a, b) => parseInt(a.kod) - parseInt(b.kod)).forEach(m => {
                const toplamBorc = m.borclar.reduce((acc, curr) => acc + parseFloat(curr.tutar), 0);
                // URL Olu≈üturma
                const fullUrl = `${window.location.origin}${window.location.pathname}?id=${m.mesken_url}`;

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3"><input type="checkbox" class="mesken-check" value="${m.dbId}"></td>
                        <td class="p-3 font-bold bg-gray-200 text-center rounded w-12">${m.kod}</td>
                        <td class="p-3">${m.sakin_adi}</td>
                        <td class="p-3">
                            ${toplamBorc > 0
                        ? `<span class="text-red-600 font-bold">-${toplamBorc} ‚Ç∫</span> <button onclick="window.payDebt('${m.dbId}')" class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded">√ñde</button>`
                        : '<span class="text-green-500"><i class="fas fa-check"></i> Temiz</span>'}
                        </td>
                        <td class="p-3">
                            <button onclick="navigator.clipboard.writeText('${fullUrl}'); alert('Link Kopyalandƒ±!')" class="text-blue-500 text-sm underline">Link Kopyala</button>
                        </td>
                        <td class="p-3">
                            <button onclick="window.deleteMesken('${m.dbId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- 5. TOPLU ƒ∞≈ûLEMLER ---

        // Bor√ß Ekleme Fonksiyonu (Generic)
        async function addDebtToMesken(dbId, aciklama, miktar) {
            const ref = doc(db, "meskenler", dbId);
            const borcObj = {
                id: Date.now() + Math.random().toString(),
                aciklama: aciklama,
                tutar: parseFloat(miktar),
                tarih: new Date().toLocaleDateString('tr-TR')
            };
            await updateDoc(ref, {
                borclar: arrayUnion(borcObj)
            });
        }

        // Toplu Bor√ß Butonu
        document.getElementById('btnTopluBorc').addEventListener('click', async () => {
            const aciklama = document.getElementById('borcAciklama').value;
            const miktar = document.getElementById('borcMiktar').value;
            if (!aciklama || !miktar) return alert("Bilgileri giriniz");

            if (confirm("T√ºm dairelere bor√ß eklenecek. Onaylƒ±yor musunuz?")) {
                for (const m of meskenListesi) {
                    await addDebtToMesken(m.dbId, aciklama, miktar);
                }
                alert("ƒ∞≈ülem tamam.");
            }
        });

        // Se√ßili Bor√ß Butonu
        document.getElementById('btnSeciliBorc').addEventListener('click', async () => {
            const aciklama = document.getElementById('borcAciklama').value;
            const miktar = document.getElementById('borcMiktar').value;
            const selected = Array.from(document.querySelectorAll('.mesken-check:checked')).map(cb => cb.value);

            if (selected.length === 0) return alert("Daire se√ßmediniz.");
            if (!aciklama || !miktar) return alert("Bilgileri giriniz");

            for (const dbId of selected) {
                await addDebtToMesken(dbId, aciklama, miktar);
            }
            alert(`${selected.length} daireye bor√ß eklendi.`);
        });

        // --- 6. GLOBAL WINDOW FONKSIYONLARI (HTML onclick i√ßin) ---

        // √ñdeme Al (Borcu sil, √∂demelere ekle, kasaya ekle)
        window.payDebt = async (dbId) => {
            const m = meskenListesi.find(x => x.dbId === dbId);
            if (!m || m.borclar.length === 0) return;

            // En eski borcu veya toplam borcu √∂deyebiliriz. Basitlik i√ßin t√ºm bor√ßlarƒ± kapatalƒ±m.
            const toplamTutar = m.borclar.reduce((acc, c) => acc + parseFloat(c.tutar), 0);

            if (!confirm(`${m.sakin_adi} i√ßin ${toplamTutar} TL tahsilat yapƒ±lacak. Onaylƒ±yor musunuz?`)) return;

            const ref = doc(db, "meskenler", dbId);
            const kasaRef = doc(db, "kasa", "ana_kasa");

            // Bor√ßlarƒ± temizle, √∂demelere ekle
            // Not: Firestore arrayUnion tek seferde birden √ßok obje i√ßin spread (...) ister ama burada basit√ße borclar arrayini bo≈üaltƒ±p √∂demelere ekleyeceƒüiz.
            // Ger√ßek projede transaction kullanmak daha g√ºvenlidir.

            const yeniOdemeler = m.borclar.map(b => ({
                ...b,
                odeme_tarihi: new Date().toLocaleDateString('tr-TR')
            }));

            // 1. Mesken G√ºncelle
            await updateDoc(ref, {
                borclar: [], // Bor√ßlarƒ± sƒ±fƒ±rla
                odemeler: arrayUnion(...yeniOdemeler)
            });

            // 2. Kasayƒ± G√ºncelle
            await updateDoc(kasaRef, {
                toplam_bakiye: (await getDoc(kasaRef)).data().toplam_bakiye + toplamTutar,
                hareketler: arrayUnion({
                    tur: 'gelir',
                    aciklama: `${m.kod} nolu daire aidat √∂demesi`,
                    tutar: toplamTutar,
                    tarih: new Date().toLocaleDateString('tr-TR')
                })
            });
        };

        window.deleteMesken = async (dbId) => {
            if (confirm("Daire silinecek?")) {
                await deleteDoc(doc(db, "meskenler", dbId)); // deleteDoc import edilmeli
            }
        };
        // Not: deleteDoc import listesine eklenmeli, a≈üaƒüƒ±da ekliyorum.
        import { deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


        // --- 7. SAKƒ∞N G√ñR√úN√úM√ú LOGIC ---
        async function loadResidentData(uniqueId) {
            const q = query(collection(db, "meskenler"), "mesken_url" == uniqueId); // Basit sorgu, unique ID ile arama
            // Firestore 'where' sorgusu:
            const meskenlerRef = collection(db, "meskenler");
            // Client side filtering yerine query kullanmak daha iyidir ama ID unique ise find da olur.
            // Ancak g√ºvenlik i√ßin query:
            const snapshot = await getDocs(query(meskenlerRef)); // Bu demo i√ßin t√ºm√ºn√º √ßekip filtreliyoruz (URL parametresi query i√ßin index gerektirebilir)

            // Ger√ßek d√ºnyada: query(collection(db, "meskenler"), where("mesken_url", "==", uniqueId))
            // Burada basit filtre:
            let found = null;
            snapshot.forEach(doc => {
                if (doc.data().mesken_url === uniqueId) found = doc.data();
            });

            if (found) {
                document.getElementById('resSakinAdi').innerText = found.sakin_adi;
                document.getElementById('resDaireNo').innerText = `Daire No: ${found.kod}`;

                // Bor√ßlar
                const unpaidDiv = document.getElementById('resUnpaidList');
                if (found.borclar.length > 0) {
                    unpaidDiv.innerHTML = '';
                    found.borclar.forEach(b => {
                        unpaidDiv.innerHTML += `
                            <div class="flex justify-between items-center bg-red-50 p-3 rounded border border-red-100">
                                <div>
                                    <div class="font-bold text-gray-700">${b.aciklama}</div>
                                    <div class="text-xs text-gray-500">${b.tarih}</div>
                                </div>
                                <div class="font-bold text-red-600">${b.tutar} ‚Ç∫</div>
                            </div>
                        `;
                    });
                }

                // Ge√ßmi≈ü
                const historyBody = document.getElementById('resHistoryBody');
                historyBody.innerHTML = '';
                found.odemeler.reverse().forEach(o => {
                    historyBody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-2 text-gray-600">${o.odeme_tarihi}</td>
                            <td class="p-2">${o.aciklama}</td>
                            <td class="p-2 text-right font-bold text-gray-700">${o.tutar} ‚Ç∫</td>
                        </tr>
                    `;
                });

                showView('resident');
            } else {
                alert("Ge√ßersiz daire linki!");
                showView('login');
            }
        }

        // --- 8. UI YARDIMCILARI ---
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden-view');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden-view');

        window.saveKasaIslem = async () => {
            const type = document.getElementById('kasaType').value;
            const desc = document.getElementById('kasaDesc').value;
            const amount = parseFloat(document.getElementById('kasaAmount').value);

            const kasaRef = doc(db, "kasa", "ana_kasa");
            const kasaDoc = await getDoc(kasaRef);
            let currentBalance = kasaDoc.data().toplam_bakiye || 0;

            if (type === 'gelir') currentBalance += amount;
            else currentBalance -= amount;

            await updateDoc(kasaRef, {
                toplam_bakiye: currentBalance,
                hareketler: arrayUnion({
                    tur: type,
                    aciklama: desc,
                    tutar: amount,
                    tarih: new Date().toLocaleDateString('tr-TR')
                })
            });
            window.closeModal('modalIncome');
        };

        // Tarih formatƒ±nƒ± (GG.AA.YYYY) JS Date objesine √ßeviren yardƒ±mcƒ± fonksiyon
        function parseDateTR(dateStr) {
            const parts = dateStr.split('.');
            // parts[0]=gun, parts[1]=ay, parts[2]=yil
            // JS Date(yil, ay-1, gun) formatƒ±ndadƒ±r.
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        window.printKasaReport = () => {
            const startVal = document.getElementById('reportStartDate').value;
            const endVal = document.getElementById('reportEndDate').value;

            if (!startVal || !endVal) {
                alert("L√ºtfen ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßiniz.");
                return;
            }

            const startDate = new Date(startVal);
            const endDate = new Date(endVal);

            // Biti≈ü g√ºn√ºn√ºn sonuna kadar kapsamasƒ± i√ßin saati 23:59 yapalƒ±m veya g√ºn√º bir sonraya kaydƒ±ralƒ±m. 
            // Basitlik i√ßin sadece tarih kar≈üƒ±la≈ütƒ±rmasƒ± yapacaƒüƒ±z.

            // Filtreleme
            const filtered = globalKasaHareketler.filter(h => {
                const hDate = parseDateTR(h.tarih);
                // Tarih kar≈üƒ±la≈ütƒ±rmasƒ± (Saatleri sƒ±fƒ±rlayarak)
                hDate.setHours(0, 0, 0, 0);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);

                return hDate >= startDate && hDate <= endDate;
            });

            if (filtered.length === 0) {
                alert("Se√ßilen tarih aralƒ±ƒüƒ±nda kayƒ±t bulunamadƒ±.");
                return;
            }

            // Toplamlarƒ± Hesapla
            let toplamGelir = 0;
            let toplamGider = 0;

            // Tabloyu Olu≈ütur
            let htmlContent = `
        <h1 class="text-2xl font-bold mb-2 text-center">Apartman Kasa Raporu</h1>
        <p class="text-center mb-6 text-gray-500">${startVal.split('-').reverse().join('.')} - ${endVal.split('-').reverse().join('.')} Tarihleri Arasƒ±</p>
        
        <table class="w-full border-collapse border border-gray-300 text-sm">
            <thead>
                <tr class="bg-gray-100">
                    <th class="border border-gray-300 p-2 text-left">Tarih</th>
                    <th class="border border-gray-300 p-2 text-left">A√ßƒ±klama</th>
                    <th class="border border-gray-300 p-2 text-left">T√ºr</th>
                    <th class="border border-gray-300 p-2 text-right">Tutar</th>
                </tr>
            </thead>
            <tbody>
    `;

            filtered.forEach(item => {
                if (item.tur === 'gelir') toplamGelir += parseFloat(item.tutar);
                else toplamGider += parseFloat(item.tutar);

                const rowColor = item.tur === 'gelir' ? 'text-green-700' : 'text-red-700';
                const turYazi = item.tur === 'gelir' ? 'GELƒ∞R' : 'Gƒ∞DER';

                htmlContent += `
            <tr>
                <td class="border border-gray-300 p-2">${item.tarih}</td>
                <td class="border border-gray-300 p-2">${item.aciklama}</td>
                <td class="border border-gray-300 p-2 font-bold ${rowColor}">${turYazi}</td>
                <td class="border border-gray-300 p-2 text-right font-mono">${item.tutar} ‚Ç∫</td>
            </tr>
        `;
            });

            htmlContent += `
            </tbody>
        </table>

        <div class="mt-6 flex justify-end">
            <table class="w-1/2 text-right border border-gray-300">
                <tr>
                    <td class="p-2 border-b">Toplam Gelir:</td>
                    <td class="p-2 border-b font-bold text-green-700">+${toplamGelir} ‚Ç∫</td>
                </tr>
                <tr>
                    <td class="p-2 border-b">Toplam Gider:</td>
                    <td class="p-2 border-b font-bold text-red-700">-${toplamGider} ‚Ç∫</td>
                </tr>
                <tr class="bg-gray-100">
                    <td class="p-2 font-bold">D√∂nem Bakiyesi:</td>
                    <td class="p-2 font-bold text-blue-800">${toplamGelir - toplamGider} ‚Ç∫</td>
                </tr>
            </table>
        </div>
        <div class="mt-10 text-xs text-gray-400 text-center">Bu rapor ${new Date().toLocaleString()} tarihinde olu≈üturulmu≈ütur.</div>
    `;

            // ƒ∞√ßeriƒüi yazdƒ±rƒ±lacak alana bas
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = htmlContent;

            // Yazdƒ±r
            window.print();
        };

        // Uygulamayƒ± Ba≈ülat
        init();
    </script>
</body>

</html>